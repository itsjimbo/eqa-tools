

## Installing eqatools package
To use the lib in code you will need remotes package which helps install from source code repositories
Map the X: Drive to the source code root folder
```
%systemroot%\system32\net.exe use x: \\prchswfsfs101\hcmdata\QI_Initiatives\EQuIP-Operations\Projects /persistent:yes
```

```
install.packages("remotes")
```

Next you can install right from the source
```
remotes::install_git(url = "file:///X:\\git\\eqatools")
```

And in YOUR project, just use the library.  Generally all of my projecs start like this

```
rm(list=ls())
library('eqatools')
eqatools::checkDependencies()

########################################################################
#
#  Global Config (Get our globals.yml file and configure any special params here..)
#
globals <- config::get(file = "globals.yml", use_parent = TRUE)

########################################################################
#
# Logging setup
#
checkDir("logs")
flog.threshold(INFO)
flog.appender(appender.file2(paste0("logs/myproject-",Sys.Date(),".log"), console=TRUE))
flog.info("Started...")

```

# Updating the eqatools package


Every once in a while this is good to update the latest version..

```

GLOBAL_LIBS<-c('remotes','config')
# automatically install any missing packages
if (length(setdiff(GLOBAL_LIBS, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(GLOBAL_LIBS, rownames(installed.packages())))  
}
invisible(lapply(GLOBAL_LIBS,require,character.only=TRUE))


remotes::install_git(url = "file:///X:\\git\\eqatools")
```



## Building a library

To build your own lib, you will need the following
```
install.packages("devtools")
install.packages("roxygen2")

library("devtools")
library(roxygen2)
devtools::install_github("klutometis/roxygen")
```

## Writing functions


A function might be like this in your R/ directory
(this was called R/test_functions.R)
```
#' A Test Function
#'
#' This function documented here
#' @param hello Say Hello
#' @keywords hello
#' @export
#' @examples
#' test_function()

test_function1 <- function(hello=TRUE){
  if(hello==TRUE){
    print("hello World")
  }
  else {
    print("Not hello world.")
  }
}

```

To generate the documentation, run
```
devtools::document()
```

This should write files to the man/ directory.
Then commit your changes.  






## Importing large amounts of data into Teradata

### Single file Example

Problem: We need to load a file into Teradata.  The file is very large and is tabbed seperated.
Solution: Use fastload

```
rm(list=ls())
library('eqatools')
eqatools::checkDependencies()

OUTPUT_FOLDER<-"C:\\TEMP"
myfile<-'myfile.tsv'

# the fastloadObject will be created in-memory as the script and other information returned such as the table name it autogenerated or primary key columns it selected
fastloadObject <-fastload(datafile = paste0(OUTPUT_FOLDER,"\\",myfile), schema = "ENTPR_EQA",file.sep = "\t" )

# for example the table name it chose
myTable<-fastloadObject$tableName

# we can write the auto-generated script to a file..
fastloadScriptFile<-paste0(OUTPUT_FOLDER,'\\',myTable,'.fastload')
fileConn<-file(fastloadScriptFile)
writeLines(fastloadObject$fastLoadScript, fileConn)
close(fileConn)

# execute the fastload and populate data for our tmp table, and log the output
flog.info(paste0("     fastload table [",myTable,"]"))
shell(paste0("fastload < \"", fastloadScriptFile,"\" >> \"",paste0(OUTPUT_FOLDER,'\\_',myTable,'.log'),"\""), wait = T)


```


### Compress a table using TD_COMPRESS

Building from the previous example we can execute sql to compress a table.
This will be done in two steps
1) You will need to collect statistics on the primary key columns
2) You will need to execute the GLOBAL_TOOLS.TD_COMPRESS() procedure


* Note: You will need the permission on teradata to exec procedure. Contact John Abraiham

```   
  library('eqatools')
  eqatools::checkDependencies()

  ########################################################################
  #
  #  Connect to  teradata
  #
  td = teraDataOdbc(user='u365042', driver.name ='auto', driver.pattern="Teradata")
  td$connect()

  schema<-"ENTPR_EQA"
  
  sqlStatistics<-fromTemplateString("COLLECT STATISTICS ON [TABLENAME]  COLUMN ( [PRIMARY_KEY_COLS] )",list(
    '[TABLENAME]'=paste(schema,myTable,sep='.'),
    '[PRIMARY_KEY_COLS]'=paste0(fastloadObject$keyCols,collapse = ",")
    
    )
  )
  flog.info(sqlStatistics)
  td$query(sqlStatistics)
  
  sqlCompress<-fromTemplateString("CALL GLOBAL_TOOLS.TD_COMPRESS('[schema]','[table]','Y',RC,MSG,OUTPUT_MESSAGES,ALTER_STMT)",list(
    '[schema]'=schema,
    '[table]'=myTable,
    '[PRIMARY_KEY_COLS]'=paste0(fastloadObject$keyCols,collapse = ",")
    
   )
  )
  flog.info(sqlCompress)
  td$query(sqlCompress)
  
```


### Multiple Files example

Problem: We need to load a bunch of files into teradta, they all have a file prefix of myfile.
Expanding the previous example we would wrap this into a function named process.


```

rm(list=ls())
library('eqatools')
eqatools::checkDependencies()


INPUT_FOLDER<-"C:\\TEMP"
GENERIC_FILENAME_PATTERN1<-'myfile'

regex<-paste0(".*",GENERIC_FILENAME_PATTERN2,".*")
fileList<-(list.files(INPUT_FOLDER,regex,recursive = T))


# first define a function process which takes a file as an argument..
process<-function(fileToProcess){

    fastloadObject <-fastload(datafile = paste0(OUTPUT_FOLDER,"\\",myfile), schema = "ENTPR_EQA",file.sep = "\t" )
    myTable<-fastloadObject$tableName
    
    fastloadScriptFile<-paste0(OUTPUT_FOLDER,'\\',myTable,'.fastload')
    fileConn<-file(fastloadScriptFile)
    writeLines(fastloadObject$fastLoadScript, fileConn)
    close(fileConn)
    
    # execute the fastload and populate data for our tmp table, and log the output
    flog.info(paste0("     fastload table [",myTable,"]"))
    shell(paste0("fastload < \"", fastloadScriptFile,"\" >> \"",paste0(OUTPUT_FOLDER,'\\_',myTable,'.log'),"\""), wait = T)

}


# now for each file we can call process 

sapply(fileList,function(myFile){
  process(myFile)
})


```


